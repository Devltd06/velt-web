<!-- Billboard Admin - Users Management -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users | Billboard Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .velt-accent { color: #D4AF37; }
    .velt-accent-bg { background-color: #D4AF37; }
    .sidebar-link.active { background-color: rgba(212, 175, 55, 0.15); border-left: 3px solid #D4AF37; }
    .modal { display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); }
    .modal.open { display: flex; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  
  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 w-64 h-full bg-gray-800 border-r border-gray-700 z-50">
    <div class="p-6 border-b border-gray-700">
      <h1 class="text-xl font-bold velt-accent">Velt Billboard</h1>
      <p class="text-gray-400 text-sm mt-1">Admin Dashboard</p>
    </div>
    <nav class="p-4">
      <a href="admin-dashboard.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        Dashboard
      </a>
      <a href="admin-bookings.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition mt-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        Bookings
      </a>
      <a href="admin-media.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition mt-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        Media
      </a>
      <a href="admin-locations.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition mt-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>
        Locations
      </a>
      <a href="admin-users.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition mt-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        Users
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 p-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h2 class="text-2xl font-bold">Users</h2>
        <p class="text-gray-400">Billboard advertisers and their activity</p>
      </div>
      
      <!-- Search -->
      <div class="relative">
        <input type="text" id="search-input" placeholder="Search users..." class="bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-4 py-2 w-64 text-white focus:border-gray-600 focus:outline-none" onkeyup="filterUsers()" />
        <svg class="w-5 h-5 text-gray-500 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-gray-400 text-sm">Total Users</p>
        <p class="text-2xl font-bold mt-1" id="stat-total">-</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-gray-400 text-sm">Active Advertisers</p>
        <p class="text-2xl font-bold mt-1 text-green-500" id="stat-active">-</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-gray-400 text-sm">Total Bookings</p>
        <p class="text-2xl font-bold mt-1 text-blue-500" id="stat-bookings">-</p>
      </div>
      <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
        <p class="text-gray-400 text-sm">Total Revenue</p>
        <p class="text-2xl font-bold mt-1 velt-accent" id="stat-revenue">-</p>
      </div>
    </div>

    <!-- Users Table -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-700/50">
          <tr>
            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-300">User</th>
            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-300">Joined</th>
            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-300">Bookings</th>
            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-300">Media</th>
            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-300">Total Spent</th>
            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-300">Actions</th>
          </tr>
        </thead>
        <tbody id="users-table" class="divide-y divide-gray-700">
          <tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- User Detail Modal -->
  <div id="user-modal" class="modal">
    <div class="bg-gray-800 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-auto m-4 border border-gray-700">
      <div class="p-6 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-800 z-10">
        <h3 class="text-lg font-bold">User Details</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="modal-content" class="p-6"></div>
    </div>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allUsers = [];

    async function fetchUsers() {
      try {
        // Fetch profiles with booking and media counts
        const { data: profiles, error: profilesError } = await supabase
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });

        if (profilesError) throw profilesError;

        // Fetch booking stats per user
        const { data: bookingStats, error: bookingsError } = await supabase
          .from('billboard_bookings')
          .select('user_id, total_price, status');

        if (bookingsError) throw bookingsError;

        // Fetch media counts per user
        const { data: mediaStats, error: mediaError } = await supabase
          .from('billboard_media')
          .select('user_id');

        if (mediaError) throw mediaError;

        // Aggregate data
        const userStats = {};
        bookingStats?.forEach(b => {
          if (!userStats[b.user_id]) {
            userStats[b.user_id] = { bookings: 0, spent: 0, media: 0 };
          }
          userStats[b.user_id].bookings++;
          if (['approved', 'active', 'completed'].includes(b.status)) {
            userStats[b.user_id].spent += b.total_price || 0;
          }
        });

        mediaStats?.forEach(m => {
          if (!userStats[m.user_id]) {
            userStats[m.user_id] = { bookings: 0, spent: 0, media: 0 };
          }
          userStats[m.user_id].media++;
        });

        allUsers = profiles?.map(p => ({
          ...p,
          stats: userStats[p.id] || { bookings: 0, spent: 0, media: 0 }
        })) || [];

        // Update summary stats
        document.getElementById('stat-total').textContent = allUsers.length;
        document.getElementById('stat-active').textContent = allUsers.filter(u => u.stats.bookings > 0).length;
        document.getElementById('stat-bookings').textContent = allUsers.reduce((sum, u) => sum + u.stats.bookings, 0);
        document.getElementById('stat-revenue').textContent = 'GHS ' + allUsers.reduce((sum, u) => sum + u.stats.spent, 0).toLocaleString();

        renderUsers();
      } catch (err) {
        console.error('Error fetching users:', err);
      }
    }

    function renderUsers(users = allUsers) {
      const tbody = document.getElementById('users-table');
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(u => `
        <tr class="hover:bg-gray-700/30 transition">
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              ${u.avatar_url ? `
                <img src="${u.avatar_url}" class="w-10 h-10 rounded-full object-cover" />
              ` : `
                <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm font-semibold">
                  ${(u.full_name || u.email || 'U').charAt(0).toUpperCase()}
                </div>
              `}
              <div>
                <p class="font-medium">${u.full_name || 'Unnamed'}</p>
                <p class="text-sm text-gray-400">${u.email || ''}</p>
              </div>
            </div>
          </td>
          <td class="px-6 py-4">
            <p class="text-sm">${formatDate(u.created_at)}</p>
          </td>
          <td class="px-6 py-4">
            <p class="font-semibold">${u.stats.bookings}</p>
          </td>
          <td class="px-6 py-4">
            <p class="font-medium">${u.stats.media}</p>
          </td>
          <td class="px-6 py-4">
            <p class="font-semibold velt-accent">GHS ${u.stats.spent.toLocaleString()}</p>
          </td>
          <td class="px-6 py-4">
            <button onclick="viewUser('${u.id}')" class="p-2 hover:bg-gray-700 rounded-lg transition" title="View Details">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            </button>
          </td>
        </tr>
      `).join('');
    }

    function filterUsers() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const filtered = allUsers.filter(u => 
        (u.full_name?.toLowerCase() || '').includes(query) ||
        (u.email?.toLowerCase() || '').includes(query) ||
        (u.username?.toLowerCase() || '').includes(query)
      );
      renderUsers(filtered);
    }

    async function viewUser(id) {
      const user = allUsers.find(u => u.id === id);
      if (!user) return;

      // Fetch user's bookings
      const { data: bookings } = await supabase
        .from('billboard_bookings')
        .select(`
          *,
          billboard_locations (name, city)
        `)
        .eq('user_id', id)
        .order('created_at', { ascending: false })
        .limit(5);

      const modal = document.getElementById('user-modal');
      const content = document.getElementById('modal-content');

      content.innerHTML = `
        <div class="space-y-6">
          <!-- User Header -->
          <div class="flex items-center gap-4">
            ${user.avatar_url ? `
              <img src="${user.avatar_url}" class="w-20 h-20 rounded-full object-cover" />
            ` : `
              <div class="w-20 h-20 rounded-full bg-gray-700 flex items-center justify-center text-2xl font-bold">
                ${(user.full_name || user.email || 'U').charAt(0).toUpperCase()}
              </div>
            `}
            <div>
              <h3 class="text-xl font-bold">${user.full_name || 'Unnamed User'}</h3>
              <p class="text-gray-400">${user.email || ''}</p>
              ${user.username ? `<p class="text-gray-500">@${user.username}</p>` : ''}
            </div>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-3 gap-4">
            <div class="bg-gray-700/50 rounded-xl p-4 text-center">
              <p class="text-2xl font-bold">${user.stats.bookings}</p>
              <p class="text-sm text-gray-400">Bookings</p>
            </div>
            <div class="bg-gray-700/50 rounded-xl p-4 text-center">
              <p class="text-2xl font-bold">${user.stats.media}</p>
              <p class="text-sm text-gray-400">Media Files</p>
            </div>
            <div class="bg-gray-700/50 rounded-xl p-4 text-center">
              <p class="text-2xl font-bold velt-accent">GHS ${user.stats.spent.toLocaleString()}</p>
              <p class="text-sm text-gray-400">Total Spent</p>
            </div>
          </div>

          <!-- Account Info -->
          <div class="bg-gray-700/50 rounded-xl p-4">
            <h4 class="text-sm text-gray-400 mb-3">Account Information</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-400">User ID</p>
                <p class="font-mono text-xs mt-1">${user.id}</p>
              </div>
              <div>
                <p class="text-gray-400">Joined</p>
                <p class="mt-1">${formatDate(user.created_at)}</p>
              </div>
            </div>
          </div>

          <!-- Recent Bookings -->
          <div>
            <h4 class="text-sm text-gray-400 mb-3">Recent Bookings</h4>
            ${bookings && bookings.length > 0 ? `
              <div class="space-y-2">
                ${bookings.map(b => `
                  <div class="bg-gray-700/50 rounded-lg p-3 flex items-center justify-between">
                    <div>
                      <p class="font-medium">${b.campaign_title}</p>
                      <p class="text-sm text-gray-400">${b.billboard_locations?.name || 'Unknown'}</p>
                    </div>
                    <div class="text-right">
                      <span class="px-2 py-1 rounded text-xs font-semibold ${
                        b.status === 'active' ? 'bg-blue-500/20 text-blue-400' :
                        b.status === 'approved' ? 'bg-green-500/20 text-green-400' :
                        b.status === 'pending' ? 'bg-orange-500/20 text-orange-400' :
                        b.status === 'rejected' ? 'bg-red-500/20 text-red-400' :
                        'bg-gray-500/20 text-gray-400'
                      }">${b.status}</span>
                      <p class="text-sm velt-accent mt-1">GHS ${(b.total_price || 0).toLocaleString()}</p>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <p class="text-gray-400 text-sm">No bookings yet</p>
            `}
          </div>
        </div>
      `;

      modal.classList.add('open');
    }

    function closeModal() {
      document.getElementById('user-modal').classList.remove('open');
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    fetchUsers();
  </script>
</body>
</html>
